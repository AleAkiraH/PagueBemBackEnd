name: "Import Existing Resources (manual)"

on:
  workflow_dispatch:
    inputs:
      components:
        description: "Comma-separated components to import (all,ecr,role,lambda)"
        required: false
        default: "all"
      aws_region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
      env:
        description: 'Environment suffix used to derive backend names (dev/prod)'
        required: false
        default: 'dev'
      lambda_role_name:
        description: '(Optional) IAM role name to import'
        required: false
        default: 'paguebem-qrreader-lambda-role'
      lambda_function_name:
        description: '(Optional) Lambda function name to import'
        required: false
        default: 'paguebem-qrreader'
      ecr_repo_name:
        description: '(Optional) ECR repository name to import'
        required: false
        default: 'paguebem-qrreader'

jobs:
  import:
    name: Import resources into Terraform state
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ github.event.inputs.aws_region }}
      COMPONENTS: ${{ github.event.inputs.components }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      - name: Compute backend names
        id: prepare
        run: |
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          OWNER_CLEAN=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | cut -c1-30)
          REPO_CLEAN=$(echo "$REPO" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | cut -c1-30)

          ENV_NAME="${{ github.event.inputs.env }}"
          if [ -z "$ENV_NAME" ]; then ENV_NAME=dev; fi

          BUCKET="${OWNER_CLEAN}-${REPO_CLEAN}-${ENV_NAME}-tfstate"
          DDB="${OWNER_CLEAN}-${REPO_CLEAN}-${ENV_NAME}-tfstate-locks"

          echo "BACKEND_BUCKET=$BUCKET" >> $GITHUB_ENV
          echo "BACKEND_TABLE=$DDB" >> $GITHUB_ENV
          echo "backend_bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "backend_table=$DDB" >> $GITHUB_OUTPUT

      - name: Import ECR repository
        if: ${{ github.event.inputs.components == 'all' || contains(github.event.inputs.components, 'ecr') }}
        run: |
          set -euo pipefail
          REPO_NAME="${{ github.event.inputs.ecr_repo_name }}"
          if ! aws ecr describe-repositories --repository-names "$REPO_NAME" --region $AWS_REGION >/dev/null 2>&1; then
            echo "ECR repository '$REPO_NAME' not found in account/region" >&2
            exit 1
          fi

          terraform -chdir=infrastructure/ecr init -backend-config="bucket=$BACKEND_BUCKET" -backend-config="dynamodb_table=$BACKEND_TABLE" -backend-config="key=ecr/terraform.tfstate" -backend-config="region=$AWS_REGION" -reconfigure -input=false

          if ! terraform -chdir=infrastructure/ecr import -lock=false aws_ecr_repository.this "$REPO_NAME"; then
            echo "Failed to import ECR repository $REPO_NAME into Terraform state" >&2
            exit 1
          fi

          terraform -chdir=infrastructure/ecr plan -input=false -detailed-exitcode -var "region=$AWS_REGION" || true

      - name: Import IAM role
        if: ${{ github.event.inputs.components == 'all' || contains(github.event.inputs.components, 'role') }}
        run: |
          set -euo pipefail
          ROLE_NAME="${{ github.event.inputs.lambda_role_name }}"
          if ! aws iam get-role --role-name "$ROLE_NAME" --region $AWS_REGION >/dev/null 2>&1; then
            echo "IAM role '$ROLE_NAME' not found in account/region" >&2
            exit 1
          fi

          terraform -chdir=infrastructure/lambda init -backend-config="bucket=$BACKEND_BUCKET" -backend-config="dynamodb_table=$BACKEND_TABLE" -backend-config="key=lambda/terraform.tfstate" -backend-config="region=$AWS_REGION" -reconfigure -input=false

          if ! terraform -chdir=infrastructure/lambda import -lock=false aws_iam_role.lambda_exec "$ROLE_NAME" -var "image_uri=__IMPORT_PLACEHOLDER__" -var "region=$AWS_REGION" -input=false; then
            echo "Failed to import IAM role $ROLE_NAME into Terraform state" >&2
            exit 1
          fi

      - name: Import Lambda function
        if: ${{ github.event.inputs.components == 'all' || contains(github.event.inputs.components, 'lambda') }}
        run: |
          set -euo pipefail
          LAMBDA_NAME="${{ github.event.inputs.lambda_function_name }}"
          if ! aws lambda get-function --function-name "$LAMBDA_NAME" --region $AWS_REGION >/dev/null 2>&1; then
            echo "Lambda function '$LAMBDA_NAME' not found in account/region" >&2
            exit 1
          fi

          # Try to fetch existing image URI (if function is container-based)
          existing_image=$(aws lambda get-function --function-name "$LAMBDA_NAME" --region $AWS_REGION --query 'Code.ImageUri' --output text 2>/dev/null || true)
          if [ -n "$existing_image" ] && [ "$existing_image" != "None" ]; then
            IMAGE_URI="$existing_image"
          else
            IMAGE_URI="__IMPORT_PLACEHOLDER__"
          fi

          terraform -chdir=infrastructure/lambda init -backend-config="bucket=$BACKEND_BUCKET" -backend-config="dynamodb_table=$BACKEND_TABLE" -backend-config="key=lambda/terraform.tfstate" -backend-config="region=$AWS_REGION" -reconfigure -input=false

          if ! terraform -chdir=infrastructure/lambda import -lock=false aws_lambda_function.this "$LAMBDA_NAME" -var "image_uri=${IMAGE_URI}" -var "region=$AWS_REGION" -input=false; then
            echo "Failed to import Lambda function $LAMBDA_NAME into Terraform state" >&2
            exit 1
          fi

          terraform -chdir=infrastructure/lambda plan -input=false -detailed-exitcode -var "image_uri=${IMAGE_URI}" -var "region=$AWS_REGION" || true

      - name: Final status
        run: |
          echo "Import complete. Verify terraform state or run 'terraform plan' in each module to confirm."